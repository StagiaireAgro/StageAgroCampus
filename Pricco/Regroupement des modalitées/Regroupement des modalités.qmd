---
title: "Regroupement de modalités"
format: html
editor: visual
---

# Importation des librairies

```{r,message=FALSE}
library(tidyverse)
library(stringr)
library(stringi)
```

# Importation du fichier

```{r}

# Socleo 
data_socleo_2021 <- read.csv("data/socleo/2021.csv")
data_socleo_2022 <- read.csv("data/socleo/2022.csv",sep = ";")

# coop circuit
data_coop_circuit_2021 <- read.csv("data/coop circuit/par annee/2021.csv",sep = ",")

# la ruche qui dit oui
data_ruche_oui_2021 <- read.csv("data/la ruche qui dit oui/historique_2021part1.csv",sep = ";")
```

# Regroupement de modalités

```{r}
# Liste des mots-clés de produits
liste_mots_cles <- c("Abricot", "Banane", "Cerise", "Clémentine", "Fraise", "Kiwi", "Nectarine", "Noix", "Pêche", "Poire", "Pomme de terre", "Jus de Pomme", "Pomme", "Prune", "Raisin", "Asperge", "Aubergine", "Carotte", "Céleri-branche", "Chou fleur", "Concombre", "Courgette", "Endive", "Haricot vert", "Laitue", "Melon", "Oignon", "Poireau", "Poivron", "Potiron", "Tomate", "Lait", "Œuf", "Boeuf", "Porc", "Poulet", "Lentille")

# Fonction
regrouper_produits <- function(df) {
  
  # I) Nettoyage du nom des modalités 
  df <- df %>%
    mutate(
      # 1. Met en minuscule
      name_clean = str_to_lower(name),
      
      # 2. Supprime les accents
      name_clean = stri_trans_general(name_clean, "Latin-ASCII"),
      
      # 3. Supprime les caractères spéciaux éventuels
      name_clean = str_replace_all(name_clean, "[^a-z ]", "")
    )
  
  # II) Supprimer les lignes contenant plus d’un mot-clé
  df <- df %>%
    rowwise() %>%
    mutate(
      mots_trouves = sum(str_to_lower(liste_mots_cles) %in% str_extract_all(name_clean, "\\b[a-z]+\\b")[[1]])
    ) %>%
    ungroup() %>%
    filter(mots_trouves <= 1) # On garde les lignes avec 0 ou 1 mot-clé trouvé
  
  # III) Variables pour marquer les lignes déjà assignées
  df$produit <- NA_character_
  
  # IV) Liste pour stocker les jeux de données filtrés
  resultats_liste <- list()
  
  # V) Boucle sur chaque mot-clé pour créer un sous-dataframe
  for (mot_cle in liste_mots_cles) {
    mask <- grepl(mot_cle, df$name_clean, ignore.case = TRUE) & is.na(df$produit)
    
    if (any(mask)) {
      df$produit[mask] <- mot_cle
      
      df_temp <- df[mask, ]
      nom_objet <- paste0("df_", gsub(" ", "_", mot_cle))
      resultats_liste[[nom_objet]] <- df_temp
    }
  }
  
  # VI) Gestion des modalités restantes (non reconnues)
  df_autres <- df[is.na(df$produit), ]
  resultats_liste[["df_autres"]] <- df_autres
  
  # VII) Retour de la liste complète des jeux de données
  return(resultats_liste)
}
```

```{r}
#########################################################
#                                                       #
#   Tests de la fonction sur différents fichiers        #
#                                                       #
######################################################### 

# Socleo 
liste_resultats_socleo_2021 <- regrouper_produits(data_socleo_2021)
liste_resultats_socleo_2022 <- regrouper_produits(data_socleo_2022)
liste_resultats_socleo_2023 <- regrouper_produits(data_socleo_2023)

# coop circuit
liste_resultats_coop_circuit_2021 <- regrouper_produits(data_coop_circuit_2021)

# la ruche qui dit oui
names(data_ruche_oui_2021)[8] <- c("name") # On renomme la variable du nom de produit pour
# que la fonction marche

liste_resultats_ruche_oui_2021 <- regrouper_produits(data_ruche_oui_2021)

###################################################################
#                                                                 #
#   Exemple d'accès à un sous-dataframe de la liste de résultat   #
#                                                                 #
################################################################### 

view(liste_resultats_socleo_2021$df_pomme)

view(liste_resultats_socleo_2022$df_autres)

view(liste_resultats_socleo_2023$df_autres)

#########################################################
#                                                       #
#   Voir les noms des produits dans df_autres           #
#                                                       #
######################################################### 

# socleo
noms_produits_socleo_autres_2021 <- liste_resultats_socleo_2021$df_autres |> group_by(name) |> count()

noms_produits_df_autres_2022 <- liste_resultats_socleo_2022$df_autres |> group_by(name) |> count()

noms_produits_socleo_autres_2023 <- liste_resultats_socleo_2023$df_autres |> group_by(name) |> count()


# coop circuit
noms_produits_coop_circuit_autres_2021 <- liste_resultats_coop_circuit_2021$df_autres |> group_by(name) |> count()


# la ruche qui dit oui
noms_produits_ruche_oui_autres_2021 <- liste_resultats_ruche_oui_2021$df_autres |> group_by(name) |> count()

```
