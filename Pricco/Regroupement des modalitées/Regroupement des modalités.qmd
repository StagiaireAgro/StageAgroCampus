---
title: "Regroupement de modalités"
format: html
editor: visual
---

# Importation des librairies

```{r,message=FALSE}
library(tidyverse)
library(stringr)
library(stringi)
```

# Importation du fichier

```{r}

# Socleo 
data_socleo_2021 <- read.csv("data/socleo/2021.csv")
data_socleo_2022 <- read.csv("data/socleo/2022.csv",sep = ";")

# coop circuit
data_coop_circuit_2021 <- read.csv("data/coop circuit/par annee/2021.csv",sep = ",")

# la ruche qui dit oui
data_ruche_oui_2021 <- read.csv("data/la ruche qui dit oui/historique_2021part1.csv",sep = ";")
```

# Séparation des fichiers

```{r}
# Liste des mots-clés de produits
liste_mots_cles <- c("Abricot", "Banane", "Cerise", "Clémentine", "Fraise", "Kiwi", "Nectarine", "Noix", "Pêche", "Poire", 
                     "Pomme de terre", "Jus de Pomme", "Pomme", "Prune", "Raisin", "Asperge", "Aubergine", "Carotte", 
                     "Céleri-branche", "Chou fleur", "Concombre", "Courgette", "Endive", "Haricot vert", "Laitue", "Melon", 
                     "Oignon", "Poireau", "Poivron", "Potiron", "Tomate", "Lait", "Œuf", "Boeuf", "Porc", "Poulet", "Lentille")

# Liste des mots-clés de produits  (au pluriel)
liste_mots_cles_pluriel <- c("Abricots", "Bananes", "Cerises", "Clémentines", "Fraises", "Kiwis", "Nectarines", "Noix", "Pêches", "Poires", 
                     "Pommes de terre", "Jus de Pommes", "Pommes", "Prunes", "Raisins", "Asperges", "Aubergines", "Carottes", 
                     "Céleri-branches", "Choux fleurs", "Concombres", "Courgettes", "Endives", "Haricots verts", "Laitues", "Melons", 
                     "Oignons", "Poireaux", "Poivrons", "Potirons", "Tomates", "Laits", "Œufs", "Boeufs", "Porcs", "Poulets", "Lentilles")

# Correspondance entre mots au pluriel et leur forme au singulier
correspondance_pluriel <- c(
  "abricots" = "abricot", "bananes" = "banane", "cerises" = "cerise", "clémentines" = "clémentine",
  "fraises" = "fraise", "kiwis" = "kiwi", "nectarines" = "nectarine", "noix" = "noix", "pêches" = "pêche",
  "poires" = "poire", "pommes de terre" = "pomme de terre", "jus de pommes" = "jus de pomme",
  "pommes" = "pomme", "prunes" = "prune", "raisins" = "raisin", "asperges" = "asperge",
  "aubergines" = "aubergine", "carottes" = "carotte", "céleris-branches" = "céleri-branche",
  "choux fleurs" = "chou fleur", "concombres" = "concombre", "courgettes" = "courgette",
  "endives" = "endive", "haricots verts" = "haricot vert", "laitues" = "laitue", "melons" = "melon",
  "oignons" = "oignon", "poireaux" = "poireau", "poivrons" = "poivron", "potirons" = "potiron",
  "tomates" = "tomate", "laits" = "lait", "œufs" = "œuf", "bœufs" = "boeuf", "porcs" = "porc",
  "poulets" = "poulet", "lentilles" = "lentille"
)

# On crée une liste combinée : mots au singulier et formes plurielles
mots_clefs_etendus <- unique(c(liste_mots_cles, names(correspondance_pluriel)))

# On trie les mots par ordre décroissant de longueur, pour éviter qu’un mot court capte une expression plus longue (ex : "pomme" avant "pomme de terre")
mots_clefs_etendus <- mots_clefs_etendus[order(nchar(mots_clefs_etendus), decreasing = TRUE)]



# Fonction principale de regroupement des produits
regrouper_produits <- function(df) {
  
  # I) Nettoyage du nom des modalités 
  df <- df %>%
    mutate(
      # 1. Mise en minuscule pour éviter les erreurs de casse
      name_clean = str_to_lower(name),
      
      # 2. Suppression des accents (ex : "pêche" → "peche")
      name_clean = stri_trans_general(name_clean, "Latin-ASCII"),
      
      # 3. Suppression des caractères spéciaux (ex : apostrophes, tirets)
      name_clean = str_replace_all(name_clean, "[^a-z ]", "")
    )
  
  # Détection vectorielle des mots au pluriel (non utilisée ensuite dans le code, pourrait être supprimée)
  df <- df %>%
    mutate(
      pluriel_detecte = str_detect(name_clean, str_c("\\b(", str_c(liste_mots_cles_pluriel, collapse = "|"), ")\\b"))
    )
  
  # II) Supprimer les lignes contenant plus d’un mot-clé
  df <- df %>%
    rowwise() %>%
    mutate(
      # On compte combien de mots-clés apparaissent dans chaque ligne (singulier + pluriel)
      mots_trouves = sum(
        str_to_lower(c(liste_mots_cles, names(correspondance_pluriel))) %in%
          str_extract_all(name_clean, "\\b[a-z]+\\b")[[1]]
      )
    ) %>%
    ungroup() %>%
    # On garde uniquement les lignes qui contiennent 0 ou 1 mot-clé
    filter(mots_trouves <= 1)

  
  # III) Création d’une variable vide pour indiquer le produit détecté
  df$produit <- NA_character_
  
  # IV) Initialisation d’une liste vide pour stocker les dataframes filtrés
  resultats_liste <- list()
  
  # V) Boucle sur chaque mot-clé (singulier ou pluriel)
  for (mot_cle in mots_clefs_etendus) {
    
    # Création d’un masque logique pour détecter les lignes contenant ce mot (non encore assignées à un produit)
    mask <- str_detect(df$name_clean, regex(paste0("\\b", mot_cle, "\\b"), ignore_case = TRUE)) & is.na(df$produit)
    
    # Si des lignes correspondent
    if (any(mask)) {
      
      # On ramène la forme trouvée à son équivalent singulier
      mot_singulier <- ifelse(
        mot_cle %in% names(correspondance_pluriel),
        correspondance_pluriel[[mot_cle]],
        mot_cle
      )
      
      # Mise en minuscule du mot-clé pour cohérence
      mot_singulier <- str_to_lower(mot_singulier)
      
      # On affecte le nom du produit à ces lignes
      df$produit[mask] <- mot_singulier
      
      # On extrait les lignes correspondantes
      df_temp <- df[mask, ]
      
      # On construit le nom de l’objet dans la liste, en remplaçant les espaces par des underscores
      nom_objet <- paste0("df_", gsub(" ", "_", mot_singulier))
      
      # On ajoute ou on complète le sous-dataframe correspondant dans la liste de résultats
      resultats_liste[[nom_objet]] <- bind_rows(resultats_liste[[nom_objet]], df_temp)
    }
  }
  
  # VI) Récupération des lignes restantes (produits non reconnus)
  df_autres <- df[is.na(df$produit), ]
  resultats_liste[["df_autres"]] <- df_autres
  
  # VII) Retour de la liste complète des jeux de données
  return(resultats_liste)
}

```

# Test pour la séparation des fichiers

```{r}
#########################################################
#                                                       #
#   Tests de la fonction sur différents fichiers        #
#                                                       #
######################################################### 

# Socleo 
liste_resultats_socleo_2021 <- regrouper_produits(data_socleo_2021)
liste_resultats_socleo_2022 <- regrouper_produits(data_socleo_2022)
liste_resultats_socleo_2023 <- regrouper_produits(data_socleo_2023)

# coop circuit
liste_resultats_coop_circuit_2021 <- regrouper_produits(data_coop_circuit_2021)

# la ruche qui dit oui
names(data_ruche_oui_2021)[8] <- c("name") # On renomme la variable du nom de produit pour que la fonction marche

liste_resultats_ruche_oui_2021 <- regrouper_produits(data_ruche_oui_2021)

###################################################################
#                                                                 #
#   Exemple d'accès à un sous-dataframe de la liste de résultat   #
#                                                                 #
################################################################### 

view(liste_resultats_socleo_2021$df_pomme)

view(liste_resultats_socleo_2022$df_autres)

view(liste_resultats_socleo_2023$df_autres)

```

# Export des fichiers séparés au format csv

```{r}
export_fichiers_separes <- function(liste_df, dossier_export = "export_csv_legumes") {
  # Crée le dossier s'il n'existe pas déjà
  if (!dir.exists(dossier_export)) {
    dir.create(dossier_export, recursive = TRUE)
  }

  # Boucle sur chaque élément de la liste
  for (nom_df in names(liste_df)) {
    # Construit le chemin de fichier (remplace les espaces par des underscores)
    chemin_fichier <- file.path(dossier_export, paste0(gsub(" ", "_", nom_df), ".csv"))
    
    # Écrit le dataframe au format CSV avec encodage UTF-8
    write.csv(liste_df[[nom_df]], file = chemin_fichier, row.names = FALSE, fileEncoding = "UTF-8")
  }

}

# Test 

export_fichiers_separes(liste_resultats_socleo_2021, dossier_export = "export_csv_legumes")

```
